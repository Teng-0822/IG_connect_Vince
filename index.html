<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚öîÔ∏èFolllow‚öîÔ∏è</title>

  <style>
  
  @import url('https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap');

  html, body {
    touch-action: manipulation;
  }

  body {
    font-family: 'MedievalSharp', cursive;
    padding: 20px;
    background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
    background-color: #f5f0e6;
    color: #3b2f1d;
  }

  h2 {
    text-align: center;
    font-size: 36px;
    color: #7b4b1c;
    text-shadow: 2px 2px #d4af37;
    margin-bottom: 30px;
  }

  .user-row {
    background: #fff9f0;
    padding: 14px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border: 2px solid #a97c50;
    border-radius: 12px;
    box-shadow: 0 2px 5px rgba(80, 40, 10, 0.4);
  }

  .user-row span {
    flex: 1;
    margin-left: 12px;
    color: #4a3213;
  }

  .username {
    font-weight: bold;
    font-size: 18px;
  }

  .status {
    margin-left: 12px;
    font-style: italic;
    color: #b08c4e;
  }

  button {
    margin: 5px;
    padding: 10px 14px;
    border: 2px solid #5c3b0b;
    border-radius: 10px;
    background: linear-gradient(145deg, #8b5e3c, #c0955d);
    color: #fff6e0;
    font-weight: bold;
    font-size: 16px;
    cursor: pointer;
    box-shadow: inset 0 1px 0 #ffd382, 0 3px 6px rgba(0, 0, 0, 0.3);
  }

  button:hover {
    background: linear-gradient(145deg, #b67638, #e6b76e);
    color: #fffaf0;
  }

  .nav-btn, .navi-btn {
   font-size: 14px;
  padding: 6px 12px;
  flex: 1;
  white-space: nowrap;
  }

  #navControls {
    position: fixed;
    bottom: 10px;
    right: 10px;
    background: #f4ead0;
    border: 4px ridge #d4af37;
    border-radius: 16px;
    padding: 16px;
    box-shadow: 0 4px 10px rgba(60, 30, 10, 0.6);
    display: flex;
    flex-direction: column;
    align-items: stretch;
    gap: 16px;
    z-index: 999;
    width: 300px;
  }

  .nav-top-row, .nav-bottom-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
  }

  #currentUsername {
    font-weight: bold;
    font-size: 18px;
    background-color: #f0e6cc;
    padding: 10px;
    border-radius: 10px;
    text-align: left;
    border: 3px double #a97c50;
    color: #6d4a1a;
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  #igLinkBtn {
    flex: 0 0 auto;
    font-size: 14px;
    padding: 6px 10px;
  }

  #navCheckbox {
    transform: scale(1.8);
    margin: 0;
    cursor: pointer;
    accent-color: #c09f58;
  }

  #floatingCounter {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 70px;
    height: 70px;
    background-color: #d4af37;
    color: #3b2f1d;
    font-size: 28px;
    font-weight: bold;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    border: 4px solid #3b2f1d;
  }

  #toast {
    visibility: hidden;
    min-width: 250px;
    background-color: #8b0000;
    color: #fffaf0;
    text-align: center;
    border-radius: 8px;
    padding: 16px;
    position: fixed;
    z-index: 99999;
    left: 50%;
    bottom: 30px;
    transform: translateX(-50%);
    font-size: 16px;
    opacity: 0;
    transition: opacity 0.5s ease-in-out, visibility 0s linear 0.5s;
  }

  #toast.show {
    visibility: visible;
    opacity: 1;
    transition-delay: 0s;
  }

  .user-row.highlight {
    background-color: #efe4c0 !important;
    border: 2px solid #d4af37;
  }

  #navControls input[type="checkbox"] {
  width: 24px;
  height: 24px;
  transform: scale(1.5);
  margin: 0 10px;
  accent-color: #8b5e3c; /* optional: match knight theme */
  cursor: pointer;
}

  label input[type="checkbox"] {
    transform: scale(6);
    margin-top: 6px;
    margin-bottom: 6px;
    cursor: pointer;
    accent-color: #c09f58;
  }
  </style>
</head>
<body>

<h2>‚öîÔ∏èFolllow‚öîÔ∏è</h2>
<button class="navi-btn" onclick="copyCheckboxStates()">üìã CC </button>
<button class="navi-btn" onclick="pushToSheet(); resetCounter()">üîÑ Reset</button>
<button class="navi-btn" onclick="generateList()">üîÉ Fetch</button>
<br>

 <!-- <button class="nav-btn" onclick="pushToSheet()">üîº Push to Sheet</button> -->
<br>
<div id="userList">üîÉ Loading data...</div>

<!-- Navigation Controls -->
<div id="navControls">
  <div class="nav-top-extra">
    <button onclick="window.open('https://instagram.com', '_blank')">Open IG</button>
    <button onclick="checkIG()">Check IG</button>
    <span id="igStatusBox" style="display:inline-block;width:20px;height:20px;border:2px solid #333;border-radius:4px;background-color:gray;"></span>
  </div>
  <div class="nav-top-row">
    <div id="currentUsername">[Username]</div>
    <button id="igLinkBtn" onclick="openCurrentIG()">Open IG</button>
    <input type="checkbox" id="currentCheckbox">
  </div>
  <div class="nav-bottom-row">
    <button class="nav-btn" id="prevBtn" onclick="prevUser(); pushToSheet(); openCurrentIG()"><==</button>
    <button class="navi-btn" id="continueBtn" onclick="runNextContainer()">‚úÖ Next Cont</button>
    <button class="nav-btn" id="nextBtn" onclick="nextUser(); pushToSheet(); openCurrentIG()">==></button>
  </div>
</div>



<!-- Counter -->
<div id="floatingCounter">0</div>

<!-- Toast -->
<div id="toast">Toast</div>


<script>
function runNextContainer() {
    window.location.href = "shortcuts://run-shortcut?name=Next%20container";
  }
function Tunnelbear() {
    window.location.href = "shortcuts://run-shortcut?name=Tunnelbear";
  }
  
const RAW_API = "https://script.google.com/macros/s/AKfycbxRzL7ZX2gfZUVCkOOtvxEprNure2zJhSqqb73J7Xz8zHpn_Gs7Z83JzzWzv-6OXclfxQ/exec";
const API_URL = "https://corsproxy.io/?" + encodeURIComponent(RAW_API);

let currentUsers = [];
let checkboxStates = {};
let currentIndex = 0;
let counterValue = 0;
let countedNavChecks = new Set(); // ONLY track what was checked in nav

const listContainer = document.getElementById("userList");
const currentNameEl = document.getElementById("currentUsername");
const currentCheckbox = document.getElementById("currentCheckbox");
const counterEl = document.getElementById("floatingCounter");

async function generateList() {
  listContainer.innerHTML = "üîÉ Fetching data...";
  let users = [];
  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 8000);
    const res = await fetch(API_URL, { signal: controller.signal });
    clearTimeout(timeoutId);
    users = await res.json();
  } catch (e) {
    listContainer.innerHTML = `<p style="color:red;">‚ùå Failed to load users: ${e.message}</p>`;
    return;
  }

  if (!users || !users.length) {
    listContainer.innerHTML = `<p style="color:orange;">‚ö†Ô∏è No usernames found in sheet.</p>`;
    return;
  }

  listContainer.innerHTML = "";
  //currentUsers = users.map(u => u.username); ito orig
  currentUsers = users;

  checkboxStates = {};

  users.forEach((user, index) => {
    const row = document.createElement("div");
    row.className = "user-row";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.checked = user.checked;
    checkbox.dataset.index = index;
    checkboxStates[index] = user.checked;
    
    // ‚úÖ Modify to track counted checkboxes
   checkbox.addEventListener("change", () => {
   checkboxStates[index] = checkbox.checked;
    
      if (checkbox.checked && !countedSet.has(index)) {
        counterValue++;
        countedSet.add(index);
      } else if (!checkbox.checked && countedSet.has(index)) {
        counterValue = Math.max(0, counterValue - 1);
        countedSet.delete(index);
      }
    
      updateCounter();
    });

    const name = document.createElement("span");
    name.textContent = user.username;

    const status = document.createElement("span");
    status.textContent = user.status;

    const btn = document.createElement("button");
    btn.textContent = "Open IG";
    btn.onclick = () => {
      window.open(`https://instagram.com/${user.username}`, "_blank");
    
      // Make this the selected user
      currentIndex = index;
      localStorage.setItem("currentIndex", currentIndex);
      updateCurrentView();
    };

    row.appendChild(checkbox);
    row.appendChild(btn);
    row.appendChild(name);
    row.appendChild(status);
    listContainer.appendChild(row);
  });

  const savedIndex = parseInt(localStorage.getItem("currentIndex"));
  currentIndex = isNaN(savedIndex) ? 0 : savedIndex;

  updateCurrentView();
  updateCounter();
}

function updateCurrentView() {
  //const username = currentUsers[currentIndex] || "‚Äî"; ito orig
  //currentNameEl.textContent = username;
  const user = currentUsers[currentIndex];
  const username = user?.username || "‚Äî";
  currentNameEl.textContent = username;

  currentCheckbox.checked = checkboxStates[currentIndex] || false;

  document.querySelectorAll(".user-row").forEach(row => row.classList.remove("highlight"));
  const currentRow = document.querySelector(`.user-row input[data-index="${currentIndex}"]`)?.parentElement;
  if (currentRow) currentRow.classList.add("highlight");
}

function nextUser() {
  if (!currentUsers || currentUsers.length === 0) return;

  let originalIndex = currentIndex;
  do {
    currentIndex++;
  } while (
    currentIndex < currentUsers.length &&
    currentUsers[currentIndex].status === "Skip"
  );

  if (currentIndex >= currentUsers.length) {
    currentIndex = originalIndex; // Revert if no valid next
    return;
  }

  localStorage.setItem("currentIndex", currentIndex);
  updateCurrentView();

  setTimeout(() => {
    openCurrentIG();
  }, 100); // Delay ensures user is selected before IG opens
}

function prevUser() {
  if (!currentUsers || currentUsers.length === 0) return;

  let originalIndex = currentIndex;
  do {
    currentIndex--;
  } while (
    currentIndex >= 0 &&
    currentUsers[currentIndex].status === "Skip"
  );

  if (currentIndex < 0) {
    currentIndex = originalIndex; // Revert if no valid previous
    return;
  }

  localStorage.setItem("currentIndex", currentIndex);
  updateCurrentView();

  setTimeout(() => {
    openCurrentIG();
  }, 100);
}

function openCurrentIG() {
  const user = currentUsers[currentIndex];
  if (user && user.username) {
    window.open(`https://instagram.com/${user.username}`, "_blank");
  }
}


currentCheckbox.addEventListener("change", () => {
  const isChecked = currentCheckbox.checked;
  checkboxStates[currentIndex] = isChecked;

  const listCheckbox = document.querySelector(`.user-row input[data-index="${currentIndex}"]`);
  if (listCheckbox) listCheckbox.checked = isChecked;

  // Only add +1 if just now checked in nav control and not already counted
  if (isChecked && !countedNavChecks.has(currentIndex)) {
    counterValue++;
    countedNavChecks.add(currentIndex);
  } else if (!isChecked && countedNavChecks.has(currentIndex)) {
    counterValue = Math.max(0, counterValue - 1);
    countedNavChecks.delete(currentIndex);
  }

  updateCounter();
});

function updateCounter() {
  counterEl.textContent = counterValue;
  counterEl.style.backgroundColor = counterValue >= 9 ? "red" : "green";
}

async function pushToSheet() {
  const updates = currentUsers.map((username, i) => ({
    username: username,
    checked: checkboxStates[i],
    row: i + 1
  }));

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify(updates),
      headers: { "Content-Type": "application/json" }
    });
    const result = await res.text();
    if (res.ok && result.includes("Updated")) {
      toast("‚úÖ Pushed successfully to Google Sheet!");
    } else {
      //toast("‚ùå Push failed");
    }
  } catch (e) {
    //toast("‚ùå Push error");
  }
}

function copyCheckboxStates() {
  const result = currentUsers.map((u, i) => checkboxStates[i] ? "TRUE" : "FALSE").join("\n");
  navigator.clipboard.writeText(result).then(() => {
    alert("‚úÖ Copied to clipboard!");
  });
}

function resetCounter() {
  counterValue = 0;
  countedNavChecks.clear(); // Clear previous tracked checks
  updateCounter();
}

function toast(msg) {
  const toast = document.getElementById("toast");
  toast.textContent = msg;
  toast.className = "show";
  setTimeout(() => {
    toast.className = toast.className.replace("show", "");
  }, 3000);
}

async function checkIG() {
  const box = document.getElementById("igStatusBox");
  box.style.backgroundColor = "gray";
  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000);
    const res = await fetch("https://www.instagram.com/", { mode: "no-cors", signal: controller.signal });
    clearTimeout(timeoutId);
    // If fetch didn't throw, consider IG accessible
    box.style.backgroundColor = "green";
  } catch (err) {
    box.style.backgroundColor = "red";
  }
}

updateCounter();
window.onload = generateList;
</script>

</body>
</html>

