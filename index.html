<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teng Box</title>
  <style>
    body {
      font-family: "Georgia", serif;
      padding: 16px;
      background: #f4f1e1 url('https://www.transparenttextures.com/patterns/paper-fibers.png');
      color: #3b2f2f;
    }

    h2 {
      font-family: 'Garamond', serif;
      font-size: 28px;
      margin-bottom: 20px;
      color: #4b382a;
      text-shadow: 1px 1px #d7c7b3;
    }

    button {
      background-color: #7e5a3a;
      color: #fffbe6;
      padding: 10px 16px;
      margin: 6px;
      border: 2px solid #4b382a;
      border-radius: 6px;
      font-family: "Georgia", serif;
      cursor: pointer;
      box-shadow: 2px 2px 0 #4b382a;
    }

    button:hover {
      background-color: #5c3c24;
    }

    .user-row {
      background: #fffbe6;
      border: 1px solid #d2b48c;
      padding: 10px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-radius: 6px;
    }

    .user-row.highlight {
      background-color: #f7e5ad !important;
    }

    .user-row span {
      flex: 1;
      margin-left: 12px;
    }

    label input[type="checkbox"], input[type="checkbox"] {
      transform: scale(1.8);
      margin: 5px;
      cursor: pointer;
      accent-color: #7e5a3a;
    }

    #floatingCounter {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 70px;
      height: 70px;
      background-color: #6b8e23;
      color: white;
      font-size: 28px;
      font-weight: bold;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    #currentUsername {
      position: fixed;
      bottom: 130px;
      right: 110px;
      background: #7e5a3a;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      writing-mode: vertical-rl;
      text-orientation: upright;
      font-size: 16px;
      height: 160px;
      text-align: center;
    }

    #currentCheckbox {
      position: fixed;
      bottom: 150px;
      right: 30px;
      transform: scale(2.5);
      accent-color: #7e5a3a;
    }

    .floating-btn {
      position: fixed;
      padding: 12px 16px;
      border-radius: 50px;
      background-color: #7e5a3a;
      color: white;
      font-size: 20px;
      z-index: 999;
      cursor: pointer;
      border: none;
    }

    #btnPrev {
      bottom: 50px;
      right: 100px;
    }

    #btnNext {
      bottom: 50px;
      right: 10px;
    }

    #btnIG {
      bottom: 210px;
      right: 10px;
    }

    .medieval-button {
      display: inline-block;
      width: 100%;
      height: 60px;
      font-size: 20px;
      text-align: center;
      line-height: 60px;
      background: #c2b280;
      color: #4b382a;
      border: 2px solid #4b382a;
      border-radius: 10px;
      font-family: "Georgia", serif;
      box-shadow: 2px 2px 0 #4b382a;
    }

    #toast {
      visibility: hidden;
      background-color: #333;
      color: #fff;
      text-align: center;
      padding: 14px;
      border-radius: 6px;
      position: fixed;
      z-index: 9999;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }

    #toast.show {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body>

<h2>Instagram User List</h2>
<button onclick="copyCheckboxStates()">üìã Copy Check</button>
<button onclick="pushToSheet(); resetCounter()">üîÑ Reset Count</button>
<button onclick="generateList()">üîÉ Fetch</button>
<br><br>
<button class="medieval-button" onclick="runNextContainer()">Next Container</button>
<br><br>

<div id="userList">üîÉ Loading data...</div>

<button id="btnPrev" class="floating-btn" onclick="prevUser(); pushToSheet(); openCurrentIG()">‚¨ÖÔ∏è</button>
<span id="currentUsername">‚Äî</span>
<button id="btnIG" class="floating-btn" onclick="openCurrentIG()">IG</button>
<input type="checkbox" id="currentCheckbox">
<button id="btnNext" class="floating-btn" onclick="nextUser(); pushToSheet(); openCurrentIG()">‚û°Ô∏è</button>

<div id="floatingCounter">0</div>
<div id="toast">Toast</div>

<script>
function runNextContainer() {
  window.location.href = "shortcuts://run-shortcut?name=Next%20container";
}

const RAW_API = "https://script.google.com/macros/s/AKfycbxxw9NFMCtNA5e9928W3yiP91JpfUnKWNFQ-RCCrzM3rRxaTJIK987sW_46QmrAjKYT/exec";
const API_URL = "https://corsproxy.io/?" + encodeURIComponent(RAW_API);

let currentUsers = [];
let checkboxStates = {};
let currentIndex = 0;
let counterValue = 0;
let countedNavChecks = new Set();

const listContainer = document.getElementById("userList");
const currentNameEl = document.getElementById("currentUsername");
const currentCheckbox = document.getElementById("currentCheckbox");
const counterEl = document.getElementById("floatingCounter");

async function generateList() {
  listContainer.innerHTML = "üîÉ Fetching data...";
  let users = [];
  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 8000);
    const res = await fetch(API_URL, { signal: controller.signal });
    clearTimeout(timeoutId);
    users = await res.json();
  } catch (e) {
    listContainer.innerHTML = `<p style="color:red;">‚ùå Failed to load users: ${e.message}</p>`;
    return;
  }

  if (!users.length) {
    listContainer.innerHTML = `<p style="color:orange;">‚ö†Ô∏è No usernames found.</p>`;
    return;
  }

  listContainer.innerHTML = "";
  currentUsers = users.map(u => u.username);
  checkboxStates = {};

  users.forEach((user, index) => {
    const row = document.createElement("div");
    row.className = "user-row";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.checked = user.checked;
    checkbox.dataset.index = index;
    checkboxStates[index] = user.checked;

    checkbox.addEventListener("change", () => {
      checkboxStates[index] = checkbox.checked;
      if (checkbox.checked && !countedNavChecks.has(index)) {
        counterValue++;
        countedNavChecks.add(index);
      } else if (!checkbox.checked && countedNavChecks.has(index)) {
        counterValue = Math.max(0, counterValue - 1);
        countedNavChecks.delete(index);
      }
      updateCounter();
    });

    const name = document.createElement("span");
    name.textContent = user.username;

    const btn = document.createElement("button");
    btn.textContent = "Open IG";
    btn.onclick = () => {
      window.open(`https://instagram.com/${user.username}`, "_blank");
      currentIndex = index;
      localStorage.setItem("currentIndex", currentIndex);
      updateCurrentView();
    };

    row.appendChild(checkbox);
    row.appendChild(btn);
    row.appendChild(name);
    listContainer.appendChild(row);
  });

  const savedIndex = parseInt(localStorage.getItem("currentIndex"));
  currentIndex = isNaN(savedIndex) ? 0 : savedIndex;

  updateCurrentView();
  updateCounter();
}

function updateCurrentView() {
  const username = currentUsers[currentIndex] || "‚Äî";
  currentNameEl.textContent = username;
  currentCheckbox.checked = checkboxStates[currentIndex] || false;

  document.querySelectorAll(".user-row").forEach(row => row.classList.remove("highlight"));
  const currentRow = document.querySelector(`.user-row input[data-index="${currentIndex}"]`)?.parentElement;
  if (currentRow) currentRow.classList.add("highlight");
}

function prevUser() {
  if (currentIndex > 0) {
    currentIndex--;
    localStorage.setItem("currentIndex", currentIndex);
    updateCurrentView();
  }
}

function nextUser() {
  if (currentIndex < currentUsers.length - 1) {
    currentIndex++;
    localStorage.setItem("currentIndex", currentIndex);
    updateCurrentView();
  }
}

function openCurrentIG() {
  const username = currentUsers[currentIndex];
  if (username) {
    window.open(`https://instagram.com/${username}`, "_blank");
  }
}

currentCheckbox.addEventListener("change", () => {
  const isChecked = currentCheckbox.checked;
  checkboxStates[currentIndex] = isChecked;

  const listCheckbox = document.querySelector(`.user-row input[data-index="${currentIndex}"]`);
  if (listCheckbox) listCheckbox.checked = isChecked;

  if (isChecked && !countedNavChecks.has(currentIndex)) {
    counterValue++;
    countedNavChecks.add(currentIndex);
  } else if (!isChecked && countedNavChecks.has(currentIndex)) {
    counterValue = Math.max(0, counterValue - 1);
    countedNavChecks.delete(currentIndex);
  }

  updateCounter();
});

function updateCounter() {
  counterEl.textContent = counterValue;
  counterEl.style.backgroundColor = counterValue >= 9 ? "red" : "#6b8e23";

  localStorage.setItem("counterValue", counterValue);
  localStorage.setItem("countedNavChecks", JSON.stringify(Array.from(countedNavChecks)));
}

async function pushToSheet() {
  const updates = currentUsers.map((username, i) => ({
    username: username,
    checked: checkboxStates[i],
    row: i + 1
  }));

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify(updates),
      headers: { "Content-Type": "application/json" }
    });
    const result = await res.text();
    if (res.ok && result.includes("Updated")) {
      toast("‚úÖ Pushed to sheet!");
    }
  } catch (e) {}
}

function copyCheckboxStates() {
  const result = currentUsers.map((u, i) => checkboxStates[i] ? "TRUE" : "FALSE").join("\n");
  navigator.clipboard.writeText(result).then(() => {
    alert("‚úÖ Copied to clipboard!");
  });
}

function resetCounter() {
  counterValue = 0;
  countedNavChecks.clear();
  updateCounter();
}

function toast(msg) {
  const toast = document.getElementById("toast");
  toast.textContent = msg;
  toast.className = "show";
  setTimeout(() => {
    toast.className = toast.className.replace("show", "");
  }, 3000);
}

const savedCounter = parseInt(localStorage.getItem("counterValue"));
if (!isNaN(savedCounter)) counterValue = savedCounter;

const savedChecks = localStorage.getItem("countedNavChecks");
if (savedChecks) {
  try {
    countedNavChecks = new Set(JSON.parse(savedChecks));
  } catch {}
}

updateCounter();
window.onload = generateList;
</script>
</body>
</html>
