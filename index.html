<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IG Checkbox Sync</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 16px;
      background: #f0f0f0;
    }
    .user-row {
      background: white;
      padding: 10px;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .user-row span {
      flex: 1;
      margin-left: 10px;
    }
    button {
      margin: 5px;
      padding: 10px;
      border: none;
      border-radius: 6px;
      background: #007aff;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #005fc1;
    }
    #navControls {
      position: fixed;
      bottom: 20px;
      right: 10px;
      background: white;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      z-index: 999;
      height: 300px;
      overflow-y: auto;
    }
    #currentUsername {
      font-weight: bold;
      font-size: 16px;
      background-color: #e0e0e0;
      padding: 6px 10px;
      border-radius: 6px;
      text-align: center;
      writing-mode: vertical-rl;
      text-orientation: upright;
      line-height: 1.2;
      height: 180px;
      overflow: hidden;
    }
    #floatingCounter {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 70px;
      height: 70px;
      background-color: green;
      color: white;
      font-size: 28px;
      font-weight: bold;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>

<h2>Instagram User List</h2>
<div id="userList">üîÉ Loading data...</div>
<br>
<button onclick="copyCheckboxStates()">üìã Copy TRUE/FALSE</button>
<button onclick="pushToSheet()">üîº Push to Sheet</button>
<button onclick="resetCounter()">üîÑ Reset Count</button>
<button onclick="generateList()">üîÉ Fetch</button> <!-- ‚úÖ FETCH BUTTON -->

<!-- Navigation Controls -->
<div id="navControls">
  <button onclick="prevUser(); openCurrentIG()">‚¨ÖÔ∏è</button>
  <span id="currentUsername">‚Äî</span>
  <button onclick="openCurrentIG()">IG</button>
  <label><input type="checkbox" id="currentCheckbox"></label>
  <button onclick="nextUser(); openCurrentIG()">‚û°Ô∏è</button>
</div>

<!-- Counter -->
<div id="floatingCounter">0</div>

<!-- Sound -->
<audio id="clickSound" preload="auto">
  <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YaQAAACAgICAgICAgICAgICAgICAf39/f39/f39/f3+AgICAgICAgICAf3+AgICAf3+AgICAgICAgH9/f3+AgH9/f3+AgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA=" type="audio/wav">
</audio>

<script>
const RAW_API = "https://script.google.com/macros/s/AKfycbxIv_GXdfYAY_vdJLzQ5y8uunDa3XvORxwe00WF4S09Qv1T8fklDqNUZF1d-TjKGCyW_w/exec";
const API_URL = "https://corsproxy.io/?" + encodeURIComponent(RAW_API);

let currentUsers = [];
let checkboxStates = {};
let currentIndex = 0;
let counterValue = 0;

const listContainer = document.getElementById("userList");
const currentNameEl = document.getElementById("currentUsername");
const currentCheckbox = document.getElementById("currentCheckbox");
const counterEl = document.getElementById("floatingCounter");

async function generateList() {
  listContainer.innerHTML = "üîÉ Fetching data...";
  let users = [];
  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 8000);
    const res = await fetch(API_URL, { signal: controller.signal });
    clearTimeout(timeoutId);
    users = await res.json();
  } catch (e) {
    listContainer.innerHTML = `<p style="color:red;">‚ùå Failed to load users: ${e.message}</p>`;
    return;
  }

  if (!users || !users.length) {
    listContainer.innerHTML = `<p style="color:orange;">‚ö†Ô∏è No usernames found in sheet.</p>`;
    return;
  }

  listContainer.innerHTML = "";
  currentUsers = users.map(u => u.username);
  checkboxStates = {};

  users.forEach((user, index) => {
    const row = document.createElement("div");
    row.className = "user-row";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.checked = user.checked;
    checkbox.dataset.index = index;
    checkboxStates[index] = user.checked;

    checkbox.addEventListener("change", () => {
      checkboxStates[index] = checkbox.checked;
      updateCounter();
    });

    const name = document.createElement("span");
    name.textContent = user.username;

    const btn = document.createElement("button");
    btn.textContent = "Open IG";
    btn.onclick = () => {
      window.open(`https://instagram.com/${user.username}`, "_blank");
    };

    row.appendChild(checkbox);
    row.appendChild(name);
    row.appendChild(btn);
    listContainer.appendChild(row);
  });

  currentIndex = 0;
  updateCurrentView();
  updateCounter();
}

function updateCurrentView() {
  const username = currentUsers[currentIndex] || "‚Äî";
  currentNameEl.textContent = username;
  currentCheckbox.checked = checkboxStates[currentIndex] || false;
}

function prevUser() {
await pushSingleToSheet(currentIndex); // üëà Push current checkbox state
  if (currentIndex > 0) {
    currentIndex--;
    updateCurrentView();
  }
}

async function nextUser() {
  await pushSingleToSheet(currentIndex); // üëà Push current checkbox state
  if (currentIndex < currentUsers.length - 1) {
    currentIndex++;
    updateCurrentView();
  }
}

 async function pushSingleToSheet(index) {
  const update = {
    username: currentUsers[index],
    checked: checkboxStates[index],
    row: index + 1
  };

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify([update]), // send as an array
      headers: {
        "Content-Type": "application/json"
      }
    });

    const result = await res.text();
    if (!res.ok || !result.includes("Updated")) {
      console.warn("‚ùå Push failed for index", index, result);
    }
  } catch (e) {
    console.warn("‚ùå Push error at index", index, e.message);
  }
}
 
  
function openCurrentIG() {
  const username = currentUsers[currentIndex];
  if (username) {
    window.open(`https://instagram.com/${username}`, "_blank");
  }
}

currentCheckbox.addEventListener("change", () => {
  checkboxStates[currentIndex] = currentCheckbox.checked;
  const listCheckbox = document.querySelector(`.user-row input[data-index="${currentIndex}"]`);
  if (listCheckbox) listCheckbox.checked = currentCheckbox.checked;
  updateCounter();
});

function updateCounter() {
  counterValue = Object.values(checkboxStates).filter(v => v).length;
  counterEl.textContent = counterValue;
  counterEl.style.backgroundColor = counterValue >= 9 ? "red" : "green";
}

async function pushToSheet() {
  const updates = currentUsers.map((username, i) => ({
    username: username,
    checked: checkboxStates[i],
    row: i + 1
  }));

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify(updates),
      headers: {
        "Content-Type": "application/json"
      }
    });

    const result = await res.text();
    if (res.ok && result.includes("Updated")) {
      alert("‚úÖ Pushed successfully to Google Sheet!");
    } else {
      alert("‚ùå Push failed: " + result);
    }
  } catch (e) {
    alert("‚ùå Push error: " + e.message);
  }
}

function copyCheckboxStates() {
  const result = currentUsers.map((u, i) => checkboxStates[i] ? "TRUE" : "FALSE").join("\n");
  navigator.clipboard.writeText(result).then(() => {
    alert("‚úÖ Copied to clipboard!");
  });
}

function resetCounter() {
  counterValue = 0;
  updateCounter();
}

document.addEventListener("click", playClickSound);
document.addEventListener("change", e => {
  if (e.target.type === "checkbox") playClickSound();
});

function playClickSound() {
  const snd = document.getElementById("clickSound");
  if (snd) {
    snd.currentTime = 0;
    snd.play().catch(() => {});
  }
}

window.onload = generateList;
</script>

</body>
</html>
